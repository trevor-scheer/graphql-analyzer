# Knope configuration for graphql-analyzer workspace
# https://knope.tech

# Single package for the entire workspace - all crates share the same version
[package]
name = "graphql-lsp"
versioned_files = ["Cargo.toml", "editors/vscode/package.json"]
changelog = "CHANGELOG.md"

# GitHub integration for PR creation and releases
[github]
owner = "trevor-scheer"
repo = "graphql-analyzer"

# Prepare a release PR - consumes changesets and creates a PR with version bump
# Currently in alpha phase. To release stable versions, remove prerelease_label.
[[workflows]]
name = "prepare-release"

[[workflows.steps]]
type = "PrepareRelease"
prerelease_label = "alpha"
# Only use changesets for changelog, not conventional commits
# (prevents including entire commit history in each release)
ignore_conventional_commits = true

[[workflows.steps]]
type = "Command"
command = "cargo check --workspace"

# Stage Cargo.lock which was updated by cargo check
[[workflows.steps]]
type = "Command"
command = "git add Cargo.lock"

# Stage changeset deletions (PrepareRelease deletes them but we need to ensure they're staged)
[[workflows.steps]]
type = "Command"
command = "git add .changeset/"

# Create release branch with new version, commit and push
[[workflows.steps]]
type = "Command"
command = "git switch -c release/v$version"

[[workflows.steps]]
type = "Command"
command = "git commit -m 'chore: prepare release v$version'"

[[workflows.steps]]
type = "Command"
command = "git push --force origin release/v$version"

[[workflows.steps]]
type = "CreatePullRequest"
base = "main"

[workflows.steps.title]
template = "chore: prepare release v$version"

[workflows.steps.body]
template = """
## Release

This PR was auto-generated by [knope](https://knope.tech) to prepare a new release.

### Changelog

$changelog

---

When merged, this will trigger the release workflow to:
1. Create git tag `v$version`
2. Build release artifacts (binaries + VSCode extension)
3. Create GitHub release
"""

# Execute the release - creates git tag and pushes it
# NOTE: We create the tag via git (not knope Release) so that pushing it
# triggers the release.yml workflow. cargo-dist handles the GitHub release.
[[workflows]]
name = "release"

[[workflows.steps]]
type = "Command"
command = "git tag v$version"

[[workflows.steps]]
type = "Command"
command = "git push origin v$version"

# Create a changeset file interactively
[[workflows]]
name = "document-change"

[[workflows.steps]]
type = "CreateChangeFile"
