# Knope configuration for graphql-analyzer workspace
# https://knope.tech

# Single package for the entire workspace - all crates share the same version
[package]
versioned_files = ["Cargo.toml", "editors/vscode/package.json"]
changelog = "CHANGELOG.md"

# GitHub integration for PR creation and releases
[github]
owner = "trevor-scheer"
repo = "graphql-analyzer"

# Prepare a release PR - consumes changesets and creates a PR with version bump
# Currently in alpha phase. To release stable versions, remove prerelease_label.
[[workflows]]
name = "prepare-release"

# Create a release branch from current HEAD
[[workflows.steps]]
type = "Command"
command = "git switch -c release"

[[workflows.steps]]
type = "PrepareRelease"
prerelease_label = "alpha"

[[workflows.steps]]
type = "Command"
command = "cargo check --workspace"

# Commit the version bump and changelog updates
[[workflows.steps]]
type = "Command"
command = "git commit -m 'chore: prepare release v$version'"
variables = { "$version" = "Version" }

# Push the release branch (force to overwrite any previous release branch)
[[workflows.steps]]
type = "Command"
command = "git push --force origin release"

[[workflows.steps]]
type = "CreatePullRequest"
base = "main"

[workflows.steps.title]
template = "chore: prepare release v{{version}}"
variables = { "version" = "Version" }

[workflows.steps.body]
template = """
## Release

This PR was auto-generated by [knope](https://knope.tech) to prepare a new release.

### Changelog

{{changelog}}

---

When merged, this will trigger the release workflow to:
1. Create git tag `v{{version}}`
2. Build release artifacts (binaries + VSCode extension)
3. Create GitHub release
"""
variables = { "version" = "Version", "changelog" = "ChangelogEntry" }

# Execute the release - creates git tag and pushes it
[[workflows]]
name = "release"

[[workflows.steps]]
type = "Release"

# Create a changeset file interactively
[[workflows]]
name = "document-change"

[[workflows.steps]]
type = "CreateChangeFile"
