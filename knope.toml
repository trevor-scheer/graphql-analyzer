# Knope configuration for graphql-analyzer workspace
# https://knope.tech

[package]
versioned_files = ["Cargo.toml", "editors/vscode/package.json"]
changelog = "CHANGELOG.md"
# Assets to upload to GitHub releases (built by CI before running `knope release`)
assets = "artifacts/*"

# GitHub integration for PR creation and releases
[github]
owner = "trevor-scheer"
repo = "graphql-analyzer"

# Prepare a release PR - consumes changesets and creates a PR with version bump
# Currently in alpha phase. To release stable versions, remove prerelease_label.
[[workflows]]
name = "prepare-release"

[[workflows.steps]]
type = "PrepareRelease"
prerelease_label = "alpha"
# Only use changesets for changelog, not conventional commits
# (prevents including entire commit history in each release)
ignore_conventional_commits = true

[[workflows.steps]]
type = "Command"
command = "cargo check --workspace"

# Stage Cargo.lock which was updated by cargo check
[[workflows.steps]]
type = "Command"
command = "git add Cargo.lock"

# Stage changeset deletions (PrepareRelease deletes them but we need to ensure they're staged)
[[workflows.steps]]
type = "Command"
command = "git add .changeset/"

# Create release branch with new version, commit and push
[[workflows.steps]]
type = "Command"
command = "git switch -c release/v$version"

[[workflows.steps]]
type = "Command"
command = "git commit -m 'chore: prepare release v$version'"

[[workflows.steps]]
type = "Command"
command = "git push --force origin release/v$version"

[[workflows.steps]]
type = "CreatePullRequest"
base = "main"

[workflows.steps.title]
template = "chore: prepare release v$version"

[workflows.steps.body]
template = """
## Release

This PR was auto-generated by [knope](https://knope.tech) to prepare a new release.

### Changelog

$changelog

---

When merged, this will trigger the release workflow to:
1. Build release artifacts (CLI binaries + VSCode extension)
2. Create GitHub release with changelog
3. Upload all artifacts
"""

# Execute the release - creates GitHub release with changelog and uploads assets
[[workflows]]
name = "release"

[[workflows.steps]]
type = "Release"

# Create a changeset file interactively
[[workflows]]
name = "document-change"

[[workflows.steps]]
type = "CreateChangeFile"
