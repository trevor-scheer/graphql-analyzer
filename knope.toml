# Knope configuration for graphql-analyzer workspace
# https://knope.tech
#
# Multi-package setup: each component has independent versioning and changelogs.
# Changesets specify which package(s) they affect:
#   ---
#   graphql-analyzer-cli: patch
#   graphql-analyzer-lsp: minor
#   ---

[packages.graphql-analyzer-cli]
versioned_files = ["crates/cli/Cargo.toml"]
changelog = "crates/cli/CHANGELOG.md"
assets = "artifacts/graphql-cli-*"

[packages.graphql-analyzer-lsp]
versioned_files = ["crates/lsp/Cargo.toml"]
changelog = "crates/lsp/CHANGELOG.md"
assets = "artifacts/graphql-lsp-*"

[packages.graphql-analyzer-mcp]
versioned_files = ["crates/mcp/Cargo.toml"]
changelog = "crates/mcp/CHANGELOG.md"
assets = "artifacts/graphql-mcp-*"

[packages.graphql-analyzer-vscode]
versioned_files = ["editors/vscode/package.json"]
changelog = "editors/vscode/CHANGELOG.md"
assets = "artifacts/*.vsix"

# GitHub integration for PR creation and releases
[github]
owner = "trevor-scheer"
repo = "graphql-analyzer"

# Prepare a release PR - consumes changesets and creates a PR with version bump
# Currently in alpha phase. To release stable versions, remove prerelease_label.
[[workflows]]
name = "prepare-release"

[[workflows.steps]]
type = "PrepareRelease"
# prerelease_label = "alpha"
ignore_conventional_commits = true

[[workflows.steps]]
type = "Command"
command = "cargo check --workspace"

[[workflows.steps]]
type = "Command"
command = "git add Cargo.lock"

# Delete consumed changesets (knope should do this but doesn't in multi-package mode)
[[workflows.steps]]
type = "Command"
command = "find .changeset -name '*.md' ! -name 'README*' -delete"

[[workflows.steps]]
type = "Command"
command = "git add .changeset/"

[[workflows.steps]]
type = "Command"
command = "git switch -c release/next"

[[workflows.steps]]
type = "Command"
command = "git commit -m 'chore: prepare release'"

[[workflows.steps]]
type = "Command"
command = "git push --force origin release/next"

[[workflows.steps]]
type = "CreatePullRequest"
base = "main"

[workflows.steps.title]
template = "chore: prepare release"

[workflows.steps.body]
template = """
## Release

This PR was auto-generated by [knope](https://knope.tech) to prepare a new release.

Review the updated `CHANGELOG.md` files in each package directory for details.

When merged, this will trigger the release workflow to:
1. Build CLI, LSP, and MCP binaries for all platforms
2. Build VSCode extension
3. Create GitHub releases with changelogs
4. Upload all artifacts
"""

# Execute the release - creates GitHub releases with changelogs and uploads assets
[[workflows]]
name = "release"

[[workflows.steps]]
type = "Release"

# Create a changeset file interactively
[[workflows]]
name = "document-change"

[[workflows.steps]]
type = "CreateChangeFile"
